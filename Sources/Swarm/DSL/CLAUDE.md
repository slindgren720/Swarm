<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>

# DSL Module

## Overview

The DSL module provides SwiftUI-inspired declarative APIs for defining agent workflows. It includes result builders, modifier chains, environment propagation, and route definitions.

## Architecture

```
AgentBlueprint (protocol)
    ↓ declares
@OrchestrationBuilder var body: Body
    ↓ builds
Orchestration (executable workflow)
    ↓ uses
Environment values, modifiers, routes
```

## Core Types

### AgentBlueprint
The primary entry point for declarative agent definition:
```swift
public protocol AgentBlueprint: Sendable {
    associatedtype Body: OrchestrationStep
    @OrchestrationBuilder var body: Body { get }
    var configuration: AgentConfiguration { get }
    var handoffs: [AnyHandoffConfiguration] { get }
}
```

Key methods: `makeOrchestration()`, `run()`, `stream()`

### BlueprintAgent
Adapter actor wrapping `AgentBlueprint` into `AgentRuntime` for use in nested orchestrations.

## Subdirectories

### `Core/` — Environment System
- **Environment property wrapper**: `@Environment(\.key) var value`
- **AgentEnvironmentValues**: Task-local environment store
- Keys: `inferenceProvider`, `memory`, `tracer`
- Environment values propagate through agent hierarchies via task-locals

### `Flow/` — Route Definitions
- **RouteBranch**: condition + step + optional name
- **RouteEntry**: `.when(RouteBranch)` or `.otherwise(step)`
- **RouterBuilder**: `@resultBuilder` for `[RouteEntry]` arrays
- DSL helpers: `When(condition) { steps }`, `Otherwise { steps }`
- Accepts agents, blueprints, or raw steps

### `Modifiers/` — Modifier Chains
SwiftUI-inspired modifier pattern for agent configuration:
- `.withMemory()` — attach memory system
- `.retrying(maxAttempts:)` — add retry behavior
- `.withTools()` — configure tool availability
- Modifiers return modified copies (value semantics)

## Result Builders

| Builder | Produces | Used By |
|---------|----------|---------|
| `@OrchestrationBuilder` | `[any OrchestrationStep]` | `Orchestration`, `AgentBlueprint.body` |
| `@RouterBuilder` | `[RouteEntry]` | `Router` step |
| `@ParallelBuilder` | `[ParallelItem]` | `Parallel` step |
| `@DAGBuilder` | `[DAGNode]` | `DAGWorkflow` step |

All builders support: `buildBlock`, `buildOptional`, `buildEither(first:)`, `buildEither(second:)`, `buildArray`

## Conventions
- Follow SwiftUI naming patterns for modifiers
- Environment keys use `EnvironmentKey` protocol with `defaultValue`
- Blueprints should be lightweight value types
- `AgentLoopBuilder` is deprecated — use `AgentBlueprint` instead
