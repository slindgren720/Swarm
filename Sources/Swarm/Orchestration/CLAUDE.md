<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 9, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #975 | 12:54 AM | ðŸŸ£ | OrchestrationBuilder Provides SwiftUI-Style DSL for Multi-Agent Workflows | ~685 |
| #972 | 12:53 AM | ðŸŸ£ | Hive Runtime Integration Implements Graph-Based Orchestration Engine | ~574 |
</claude-mem-context>

# Orchestration Module

## Overview

The orchestration module provides multi-agent coordination through composable step types, a result builder DSL, and dual runtime support (Swift-native and Hive DAG).

## Architecture

```
OrchestrationBuilder (@resultBuilder)
    â†“ composes
[OrchestrationStep] (protocol conformers)
    â†“ executed by
Orchestration (AgentRuntime)
    â†“ delegates to
OrchestrationSwiftEngine  OR  OrchestrationHiveEngine
```

## Core Protocol

```swift
public protocol OrchestrationStep: Sendable {
    func execute(_ input: String, context: OrchestrationStepContext) async throws -> AgentResult
    func execute(_ input: String, hooks: (any RunHooks)?) async throws -> AgentResult
}
```

## Step Types Reference

| Step | Purpose | Key Config |
|------|---------|------------|
| `AgentStep` | Wraps single agent | Optional name, handoff config |
| `Sequential` | Linear chain | `OutputTransformer`: `.passthrough`, `.withMetadata`, `.custom()` |
| `Parallel` | Concurrent fan-out | `MergeStrategy`, `ParallelErrorHandling`, `maxConcurrency` |
| `Router` | Condition-based routing | `RouteBranch` conditions, `Otherwise()` fallback |
| `Transform` | Data transformation | `(String) async throws -> String` closure |
| `Branch` | If/else conditional | Async condition closure, `.then`/`.otherwise` steps |
| `DAGWorkflow` | Dependency graph | `DAGNode` with explicit dependency lists |
| `RepeatWhile` | Loop step | Condition closure, max iteration limit |
| `Guard` | Precondition check | Validation closure, error on failure |

## Hive DAG Compilation (Smart Graph)

The `OrchestrationHiveEngine` compiles steps into Hive DAG graphs using:

- **CompileContext**: Generates unique node IDs across compilation
- **CompiledStep**: Graph fragment with `entryNodes` and `exitNodes`
- **Root passthrough node**: Always at index 0, invisible to user callbacks

### Compilation Rules
- Sequential â†’ linear chain of edges
- Parallel â†’ fan-out to branch nodes, merge node to collect
- Router â†’ single node evaluates conditions
- DAG â†’ respects explicit dependency edges
- Step index 0 events are filtered (root passthrough node)

### Channel Schema
- `currentInputKey`: Latest input string
- `accumulatorKey`: Merged result state (tool calls, metadata)
- `branchResultsKey`: Array of branch results from parallel execution
- `routerDecisionKey`: Router path tracking

## Adding New Step Types

1. Create `Sources/Swarm/Orchestration/MyStep.swift` conforming to `OrchestrationStep`
2. Add `buildExpression` overload in `OrchestrationBuilder`
3. Add compilation case in `OrchestrationHiveEngine.compileStep()`
4. Write tests in `Tests/SwarmTests/Orchestration/`
5. Ensure Hive execution path works

## Conventions
- All step types must be `Sendable`
- Use `Log.orchestration` for logging
- Metadata keys use dot-notation namespacing: `orchestration.step_0.key`
- Error handling through `OrchestrationError` enum
- Duration tracking via `ContinuousClock`
