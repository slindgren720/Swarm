# EXAMPLE: Coverage Steps to Add to .github/workflows/swift.yml
#
# IMPORTANT: This is NOT a complete workflow file!
# Copy the steps below into your existing build-and-test job
# in .github/workflows/swift.yml (around line 43-44)
#
# Replace the current test step (line 43-44) with:

    - name: Run tests with coverage
      run: swift test --enable-code-coverage

    - name: Generate coverage reports
      run: |
        # Find test binary
        TEST_BINARY=$(find .build/debug -name "SwiftAgentsPackageTests.xctest" | head -n 1)
        BINARY_NAME=$(basename "$TEST_BINARY" .xctest)
        ACTUAL_BINARY="$TEST_BINARY/Contents/MacOS/$BINARY_NAME"

        # Create coverage directory
        mkdir -p .build/coverage

        # Generate text summary
        echo "üìä Coverage Summary:"
        xcrun llvm-cov report \
          "$ACTUAL_BINARY" \
          -instr-profile=.build/debug/codecov/default.profdata \
          -ignore-filename-regex=".build|Tests" \
          -use-color

        # Generate HTML report
        xcrun llvm-cov show \
          "$ACTUAL_BINARY" \
          -instr-profile=.build/debug/codecov/default.profdata \
          -ignore-filename-regex=".build|Tests" \
          -format=html \
          -output-dir=.build/coverage/html

        # Generate lcov for third-party tools
        xcrun llvm-cov export \
          "$ACTUAL_BINARY" \
          -instr-profile=.build/debug/codecov/default.profdata \
          -ignore-filename-regex=".build|Tests" \
          -format=lcov \
          > .build/coverage/coverage.lcov

        # Generate JSON
        xcrun llvm-cov export \
          "$ACTUAL_BINARY" \
          -instr-profile=.build/debug/codecov/default.profdata \
          -ignore-filename-regex=".build|Tests" \
          -format=text \
          > .build/coverage/coverage.json

    - name: Extract coverage percentage
      id: coverage
      run: |
        TEST_BINARY=$(find .build/debug -name "SwiftAgentsPackageTests.xctest" | head -n 1)
        BINARY_NAME=$(basename "$TEST_BINARY" .xctest)
        ACTUAL_BINARY="$TEST_BINARY/Contents/MacOS/$BINARY_NAME"

        COVERAGE=$(xcrun llvm-cov report \
          "$ACTUAL_BINARY" \
          -instr-profile=.build/debug/codecov/default.profdata \
          -ignore-filename-regex=".build|Tests" | \
          tail -n 1 | \
          awk '{print $NF}' | \
          sed 's/%//')

        echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "‚úÖ Total Coverage: $COVERAGE%"

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: .build/coverage/
        retention-days: 30

    - name: Check coverage threshold
      run: |
        MIN_COVERAGE=70
        CURRENT_COVERAGE=${{ steps.coverage.outputs.percentage }}

        echo "Current Coverage: $CURRENT_COVERAGE%"
        echo "Minimum Required: $MIN_COVERAGE%"

        if (( $(echo "$CURRENT_COVERAGE < $MIN_COVERAGE" | bc -l) )); then
          echo "‚ùå Coverage is below minimum threshold!"
          exit 1
        else
          echo "‚úÖ Coverage meets minimum threshold"
        fi

    # Optional: Post coverage as PR comment
    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ steps.coverage.outputs.percentage }}';
          const minCoverage = '70';
          const status = parseFloat(coverage) >= parseFloat(minCoverage) ? '‚úÖ' : '‚ùå';

          const comment = `## ${status} Code Coverage Report

          **Current Coverage:** ${coverage}%
          **Minimum Required:** ${minCoverage}%

          üìä [View detailed reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Download the \`coverage-reports\` artifact from the workflow run to view detailed HTML reports.`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
